<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safar-e-GIKI Admin Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h1 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        .login-box h2 { text-align: center; color: #666; margin-bottom: 30px; font-weight: normal; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-block { width: 100%; justify-content: center; }
        
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        /* Dashboard Layout */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 20px; }
        
        .main-content { display: flex; min-height: calc(100vh - 60px); }
        
        .sidebar {
            width: 220px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 15px 0;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
        
        .sidebar-section { padding: 10px 20px; font-size: 11px; color: #999; text-transform: uppercase; font-weight: 600; }
        
        .sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            font-size: 14px;
            color: #555;
        }
        .sidebar-item:hover { background: #f8f9fa; color: var(--primary); }
        .sidebar-item.active { background: #f0f0ff; color: var(--primary); border-left: 3px solid var(--primary); font-weight: 500; }
        .sidebar-item span { font-size: 16px; }
        
        .content { flex: 1; padding: 25px; overflow-x: auto; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-card .stat-icon { font-size: 32px; margin-bottom: 10px; }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .stat-card .stat-label { color: #666; font-size: 13px; margin-top: 5px; }
        
        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; white-space: nowrap; }
        tr:hover { background: #fafafa; }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-secondary { background: #e9ecef; color: #495057; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.show { display: block; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Action buttons in table */
        .action-btns { display: flex; gap: 5px; }
        
        /* Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        
        .hidden { display: none !important; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div class="login-container" id="loginSection">
        <div class="login-box">
            <h1>üöå Safar-e-GIKI</h1>
            <h2>Admin Dashboard</h2>
            <div class="error-msg" id="loginError">Invalid credentials</div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="phoneInput" placeholder="923001234567" required>
                </div>
                <div class="form-group">
                    <label>Admin PIN</label>
                    <input type="password" id="pinInput" placeholder="Enter PIN" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Login</button>
            </form>
        </div>
    </div>
    
    <!-- Dashboard Section -->
    <div class="dashboard" id="dashboardSection">
        <header class="header">
            <h1>üöå Safar-e-GIKI Admin</h1>
            <div>
                <span id="adminPhoneDisplay" style="margin-right: 20px; opacity: 0.8;"></span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        
        <div class="main-content">
            <nav class="sidebar">
                <div class="sidebar-section">Overview</div>
                <div class="sidebar-item active" data-section="dashboard"><span>üìä</span> Dashboard</div>
                
                <div class="sidebar-section">Settings</div>
                <div class="sidebar-item" data-section="fares"><span>üí∞</span> Fares</div>
                <div class="sidebar-item" data-section="dates"><span>üìÖ</span> Dates</div>
                <div class="sidebar-item" data-section="luggage"><span>üß≥</span> Luggage</div>
                <div class="sidebar-item" data-section="locations"><span>üìç</span> Locations</div>
                
                <div class="sidebar-section">Database</div>
                <div class="sidebar-item" data-section="buses"><span>üöå</span> Buses</div>
                <div class="sidebar-item" data-section="available-dates"><span>üìÜ</span> Available Dates</div>
                <div class="sidebar-item" data-section="bookings"><span>üé´</span> Bookings</div>
                <div class="sidebar-item" data-section="kb"><span>üìö</span> Knowledge Base</div>
                
                <div class="sidebar-section">System</div>
                <div class="sidebar-item" data-section="audit"><span>üìã</span> Audit Log</div>
            </nav>
            
            <main class="content">
                <!-- Dashboard Overview -->
                <section id="dashboard-section">
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-icon">üé´</div>
                            <div class="stat-value" id="stat-total-bookings">0</div>
                            <div class="stat-label">Total Bookings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚è≥</div>
                            <div class="stat-value" id="stat-pending-bookings">0</div>
                            <div class="stat-label">Pending Bookings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-value" id="stat-pending-payments">0</div>
                            <div class="stat-label">Pending Payments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üíµ</div>
                            <div class="stat-value" id="stat-revenue">Rs. 0</div>
                            <div class="stat-label">Confirmed Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üöå</div>
                            <div class="stat-value" id="stat-active-buses">0</div>
                            <div class="stat-label">Active Buses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí∫</div>
                            <div class="stat-value" id="stat-seats-available">0</div>
                            <div class="stat-label">Seats Available</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Recent Bookings</h2>
                        <div class="table-container">
                            <table id="recentBookingsTable">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Passenger</th>
                                        <th>Route</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Payment</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Fares Section -->
                <section id="fares-section" class="hidden">
                    <div class="card">
                        <h2>üí∞ Ticket Fares</h2>
                        <div class="form-group">
                            <label>Multan Fare (PKR)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="fare-multan" value="3500" style="flex: 1;">
                                <button class="btn btn-primary" onclick="saveFare('multan')">Save</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Bahawalpur Fare (PKR)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="fare-bahawalpur" value="4200" style="flex: 1;">
                                <button class="btn btn-primary" onclick="saveFare('bahawalpur')">Save</button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Dates Section -->
                <section id="dates-section" class="hidden">
                    <div class="card">
                        <h2>üìÖ Travel Dates</h2>
                        <div class="form-group">
                            <label>Outbound Dates (comma-separated)</label>
                            <input type="text" id="outbound-dates" value="2026-01-03,2026-01-04">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="dates-description" rows="2">Saturday 3rd January 2026 and Sunday 4th January 2026</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveDates()">Save Outbound Dates</button>
                        
                        <hr style="margin: 30px 0;">
                        
                        <div class="form-group">
                            <label>Return Date</label>
                            <input type="date" id="return-date" value="2026-01-18">
                        </div>
                        <div class="form-group">
                            <label>Return Description</label>
                            <textarea id="return-description" rows="2">Sunday 18th January 2026 for both Multan and Bahawalpur</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveReturn()">Save Return Dates</button>
                    </div>
                </section>
                
                <!-- Luggage Section -->
                <section id="luggage-section" class="hidden">
                    <div class="card">
                        <h2>üß≥ Luggage Policy</h2>
                        <div class="form-group">
                            <label>Max Bags</label>
                            <input type="number" id="luggage-bags" value="2" min="1" max="5">
                        </div>
                        <div class="form-group">
                            <label>Bag Size</label>
                            <select id="luggage-size">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Policy Note</label>
                            <textarea id="luggage-note" rows="3">No extra price for extra luggage but only 2 medium sized bags maximum alongside a hand carry recommended.</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveLuggage()">Save Luggage Policy</button>
                    </div>
                </section>
                
                <!-- Locations Section -->
                <section id="locations-section" class="hidden">
                    <div class="card">
                        <h2>üìç Pickup/Drop Locations</h2>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="locations-status">
                                <option value="TBD">To Be Announced</option>
                                <option value="confirmed">Confirmed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Locations (one per line)</label>
                            <textarea id="locations-list" rows="4">GIKI Main Gate
Multan - Chungi No. 9
Bahawalpur - General Bus Stand</textarea>
                        </div>
                        <div class="form-group">
                            <label>Note</label>
                            <textarea id="locations-note" rows="2">Exact timings will be shared closer to travel date</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveLocations()">Save Locations</button>
                    </div>
                </section>
                
                <!-- Buses Section -->
                <section id="buses-section" class="hidden">
                    <div class="card">
                        <h2>
                            üöå Buses Management
                            <button class="btn btn-success btn-sm" onclick="openBusModal()">+ Add Bus</button>
                        </h2>
                        <div class="table-container">
                            <table id="busesTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Seats</th>
                                        <th>Price</th>
                                        <th>Departure</th>
                                        <th>Arrival</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Available Dates Section -->
                <section id="available-dates-section" class="hidden">
                    <div class="card">
                        <h2>
                            üìÜ Available Dates
                            <button class="btn btn-success btn-sm" onclick="openDateModal()">+ Add Date</button>
                        </h2>
                        <div class="table-container">
                            <table id="availableDatesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Route</th>
                                        <th>Bus</th>
                                        <th>Seats Available</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Bookings Section -->
                <section id="bookings-section" class="hidden">
                    <div class="card">
                        <h2>üé´ Bookings Management</h2>
                        <div class="filters">
                            <select id="bookingStatusFilter" onchange="loadBookings()">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button class="btn btn-info btn-sm" onclick="loadBookings()">üîÑ Refresh</button>
                        </div>
                        <div class="table-container">
                            <table id="bookingsTable">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Passenger</th>
                                        <th>Phone</th>
                                        <th>Route</th>
                                        <th>Date</th>
                                        <th>Seats</th>
                                        <th>Amount</th>
                                        <th>Payment</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Knowledge Base Section -->
                <section id="kb-section" class="hidden">
                    <div class="card">
                        <h2>
                            üìö Knowledge Base
                            <div>
                                <button class="btn btn-warning btn-sm" onclick="rebuildKB()">üîÑ Rebuild KB</button>
                                <button class="btn btn-success btn-sm" onclick="openKBModal()">+ Add Entry</button>
                            </div>
                        </h2>
                        <div class="table-container">
                            <table id="kbTable">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Question</th>
                                        <th>Answer</th>
                                        <th>Keywords</th>
                                        <th>Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Audit Log Section -->
                <section id="audit-section" class="hidden">
                    <div class="card">
                        <h2>üìã Audit Log <button class="btn btn-info btn-sm" onclick="loadAuditLog()">üîÑ Refresh</button></h2>
                        <div class="table-container">
                            <table id="auditTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Admin</th>
                                        <th>Action</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <!-- Bus Modal -->
    <div class="modal" id="busModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="busModalTitle">Add Bus</h3>
                <button class="modal-close" onclick="closeModal('busModal')">&times;</button>
            </div>
            <form id="busForm">
                <input type="hidden" id="bus-id">
                <div class="form-group">
                    <label>Bus Name</label>
                    <input type="text" id="bus-name" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="bus-type">
                        <option value="business">Business</option>
                        <option value="executive">Executive</option>
                        <option value="sleeper">Sleeper</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Total Seats</label>
                    <input type="number" id="bus-seats" value="27" required>
                </div>
                <div class="form-group">
                    <label>Price (PKR)</label>
                    <input type="number" id="bus-price" value="3500" required>
                </div>
                <div class="form-group">
                    <label>Departure Time</label>
                    <input type="time" id="bus-departure" value="08:00" required>
                </div>
                <div class="form-group">
                    <label>Arrival Time</label>
                    <input type="time" id="bus-arrival" value="14:00" required>
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <input type="text" id="bus-duration" value="6 hrs">
                </div>
                <div class="form-group">
                    <label>Amenities (comma-separated)</label>
                    <input type="text" id="bus-amenities" value="AC, Charging Ports">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('busModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Date Modal -->
    <div class="modal" id="dateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="dateModalTitle">Add Available Date</h3>
                <button class="modal-close" onclick="closeModal('dateModal')">&times;</button>
            </div>
            <form id="dateForm">
                <input type="hidden" id="date-id">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date-value" required>
                </div>
                <div class="form-group">
                    <label>Route</label>
                    <select id="date-route">
                        <option value="GIKI-Multan">GIKI ‚Üí Multan</option>
                        <option value="GIKI-Bahawalpur">GIKI ‚Üí Bahawalpur</option>
                        <option value="Multan-GIKI">Multan ‚Üí GIKI</option>
                        <option value="Bahawalpur-GIKI">Bahawalpur ‚Üí GIKI</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bus</label>
                    <select id="date-bus"></select>
                </div>
                <div class="form-group">
                    <label>Seats Available</label>
                    <input type="number" id="date-seats" value="27" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('dateModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- KB Entry Modal -->
    <div class="modal" id="kbModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="kbModalTitle">Add KB Entry</h3>
                <button class="modal-close" onclick="closeModal('kbModal')">&times;</button>
            </div>
            <form id="kbForm">
                <input type="hidden" id="kb-id">
                <div class="form-group">
                    <label>Category</label>
                    <select id="kb-category">
                        <option value="dates_schedule">Dates & Schedule</option>
                        <option value="fares">Fares</option>
                        <option value="route">Route</option>
                        <option value="return_service">Return Service</option>
                        <option value="luggage">Luggage</option>
                        <option value="locations">Locations</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Question</label>
                    <input type="text" id="kb-question" required>
                </div>
                <div class="form-group">
                    <label>Answer</label>
                    <textarea id="kb-answer" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>Keywords (comma-separated)</label>
                    <input type="text" id="kb-keywords">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('kbModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <script>
        const API_BASE = '';
        let adminPhone = '';
        let busesData = [];
        
        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('phoneInput').value;
            const pin = document.getElementById('pinInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, pin })
                });
                
                if (response.ok) {
                    adminPhone = phone;
                    localStorage.setItem('adminPhone', phone);
                    showDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch (error) {
                adminPhone = phone;
                localStorage.setItem('adminPhone', phone);
                showDashboard();
            }
        });
        
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.add('active');
            document.getElementById('adminPhoneDisplay').textContent = `Admin: ${adminPhone}`;
            loadDashboard();
        }
        
        function logout() {
            localStorage.removeItem('adminPhone');
            location.reload();
        }
        
        if (localStorage.getItem('adminPhone')) {
            adminPhone = localStorage.getItem('adminPhone');
            showDashboard();
        }
        
        // Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                const section = item.dataset.section;
                document.querySelectorAll('.content section').forEach(s => s.classList.add('hidden'));
                document.getElementById(`${section}-section`).classList.remove('hidden');
                
                // Load data for section
                if (section === 'buses') loadBuses();
                else if (section === 'available-dates') loadAvailableDates();
                else if (section === 'bookings') loadBookings();
                else if (section === 'kb') loadKB();
                else if (section === 'audit') loadAuditLog();
                else if (section === 'dashboard') loadDashboard();
            });
        });
        
        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Modal helpers
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // API helper
        async function apiCall(url, method = 'GET', data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) {
                data.admin_phone = adminPhone;
                options.body = JSON.stringify(data);
            }
            const response = await fetch(API_BASE + url, options);
            return response.json();
        }
        
        // Dashboard
        async function loadDashboard() {
            try {
                const stats = await apiCall('/admin/stats');
                document.getElementById('stat-total-bookings').textContent = stats.total_bookings || 0;
                document.getElementById('stat-pending-bookings').textContent = stats.pending_bookings || 0;
                document.getElementById('stat-pending-payments').textContent = stats.pending_payments || 0;
                document.getElementById('stat-revenue').textContent = `Rs. ${(stats.total_revenue || 0).toLocaleString()}`;
                document.getElementById('stat-active-buses').textContent = stats.active_buses || 0;
                document.getElementById('stat-seats-available').textContent = stats.total_seats_available || 0;
                
                // Load recent bookings
                const bookingsData = await apiCall('/admin/bookings?limit=5');
                const tbody = document.querySelector('#recentBookingsTable tbody');
                tbody.innerHTML = (bookingsData.bookings || []).map(b => `
                    <tr>
                        <td>${b.booking_id}</td>
                        <td>${b.passenger_name}</td>
                        <td>${b.from_location} ‚Üí ${b.to_location}</td>
                        <td>${b.travel_date}</td>
                        <td>Rs. ${b.total_amount.toLocaleString()}</td>
                        <td><span class="badge badge-${b.payment_status === 'confirmed' ? 'success' : 'warning'}">${b.payment_status}</span></td>
                        <td><span class="badge badge-${b.booking_status === 'confirmed' ? 'success' : b.booking_status === 'cancelled' ? 'danger' : 'warning'}">${b.booking_status}</span></td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }
        
        // Settings
        async function saveFare(dest) {
            const value = document.getElementById(`fare-${dest}`).value;
            await apiCall('/admin/settings/fares', 'POST', { destination: dest, amount: parseInt(value) });
            showToast(`${dest} fare updated to Rs. ${value}`);
        }
        
        async function saveDates() {
            const dates = document.getElementById('outbound-dates').value.split(',');
            const desc = document.getElementById('dates-description').value;
            await apiCall('/admin/settings/dates', 'POST', { dates, description: desc });
            showToast('Outbound dates updated');
        }
        
        async function saveReturn() {
            const date = document.getElementById('return-date').value;
            const desc = document.getElementById('return-description').value;
            await apiCall('/admin/settings/return', 'POST', { date, description: desc });
            showToast('Return service updated');
        }
        
        async function saveLuggage() {
            const bags = document.getElementById('luggage-bags').value;
            const size = document.getElementById('luggage-size').value;
            const note = document.getElementById('luggage-note').value;
            await apiCall('/admin/settings/luggage', 'POST', { key: 'bags', value: bags });
            await apiCall('/admin/settings/luggage', 'POST', { key: 'size', value: size });
            await apiCall('/admin/settings/luggage', 'POST', { key: 'note', value: note });
            showToast('Luggage policy updated');
        }
        
        async function saveLocations() {
            const status = document.getElementById('locations-status').value;
            const list = document.getElementById('locations-list').value;
            const note = document.getElementById('locations-note').value;
            await apiCall('/admin/settings/locations', 'POST', { action: 'status', value: status });
            await apiCall('/admin/settings/locations', 'POST', { action: 'note', value: note });
            showToast('Locations updated');
        }
        
        // Buses CRUD
        async function loadBuses() {
            const data = await apiCall('/admin/buses');
            busesData = data.buses || [];
            const tbody = document.querySelector('#busesTable tbody');
            tbody.innerHTML = busesData.map(b => `
                <tr>
                    <td>${b.name}</td>
                    <td>${b.bus_type}</td>
                    <td>${b.total_seats}</td>
                    <td>Rs. ${b.price.toLocaleString()}</td>
                    <td>${b.departure_time}</td>
                    <td>${b.arrival_time}</td>
                    <td><span class="badge badge-${b.is_active ? 'success' : 'secondary'}">${b.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-btns">
                        <button class="btn btn-info btn-sm" onclick="editBus('${b.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteBus('${b.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openBusModal(bus = null) {
            document.getElementById('busModalTitle').textContent = bus ? 'Edit Bus' : 'Add Bus';
            document.getElementById('bus-id').value = bus?.id || '';
            document.getElementById('bus-name').value = bus?.name || '';
            document.getElementById('bus-type').value = bus?.bus_type || 'business';
            document.getElementById('bus-seats').value = bus?.total_seats || 27;
            document.getElementById('bus-price').value = bus?.price || 3500;
            document.getElementById('bus-departure').value = bus?.departure_time || '08:00';
            document.getElementById('bus-arrival').value = bus?.arrival_time || '14:00';
            document.getElementById('bus-duration').value = bus?.duration || '6 hrs';
            document.getElementById('bus-amenities').value = (bus?.amenities || []).join(', ');
            document.getElementById('busModal').classList.add('active');
        }
        
        function editBus(id) {
            const bus = busesData.find(b => b.id === id);
            openBusModal(bus);
        }
        
        document.getElementById('busForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('bus-id').value;
            const data = {
                name: document.getElementById('bus-name').value,
                bus_type: document.getElementById('bus-type').value,
                total_seats: parseInt(document.getElementById('bus-seats').value),
                price: parseInt(document.getElementById('bus-price').value),
                departure_time: document.getElementById('bus-departure').value,
                arrival_time: document.getElementById('bus-arrival').value,
                duration: document.getElementById('bus-duration').value,
                amenities: document.getElementById('bus-amenities').value.split(',').map(s => s.trim()).filter(Boolean)
            };
            
            if (id) {
                await apiCall(`/admin/buses/${id}`, 'PUT', data);
            } else {
                await apiCall('/admin/buses', 'POST', data);
            }
            closeModal('busModal');
            loadBuses();
            showToast('Bus saved successfully');
        });
        
        async function deleteBus(id) {
            if (!confirm('Are you sure you want to delete this bus?')) return;
            await apiCall(`/admin/buses/${id}`, 'DELETE', {});
            loadBuses();
            showToast('Bus deleted');
        }
        
        // Available Dates CRUD
        async function loadAvailableDates() {
            const data = await apiCall('/admin/available-dates');
            const tbody = document.querySelector('#availableDatesTable tbody');
            tbody.innerHTML = (data.dates || []).map(d => `
                <tr>
                    <td>${d.date}</td>
                    <td>${d.route}</td>
                    <td>${d.buses?.name || 'N/A'}</td>
                    <td>${d.seats_available}</td>
                    <td class="action-btns">
                        <button class="btn btn-info btn-sm" onclick="editDate('${d.id}', '${d.date}', '${d.route}', '${d.bus_id}', ${d.seats_available})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDate('${d.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function openDateModal(dateData = null) {
            // Load buses for dropdown
            if (busesData.length === 0) {
                const data = await apiCall('/admin/buses');
                busesData = data.buses || [];
            }
            document.getElementById('date-bus').innerHTML = busesData.filter(b => b.is_active).map(b => 
                `<option value="${b.id}">${b.name} (${b.total_seats} seats)</option>`
            ).join('');
            
            document.getElementById('dateModalTitle').textContent = dateData ? 'Edit Date' : 'Add Available Date';
            document.getElementById('date-id').value = dateData?.id || '';
            document.getElementById('date-value').value = dateData?.date || '';
            document.getElementById('date-route').value = dateData?.route || 'GIKI-Multan';
            document.getElementById('date-bus').value = dateData?.bus_id || '';
            document.getElementById('date-seats').value = dateData?.seats_available || 27;
            document.getElementById('dateModal').classList.add('active');
        }
        
        function editDate(id, date, route, bus_id, seats) {
            openDateModal({ id, date, route, bus_id, seats_available: seats });
        }
        
        document.getElementById('dateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('date-id').value;
            const data = {
                date: document.getElementById('date-value').value,
                route: document.getElementById('date-route').value,
                bus_id: document.getElementById('date-bus').value,
                seats_available: parseInt(document.getElementById('date-seats').value)
            };
            
            if (id) {
                await apiCall(`/admin/available-dates/${id}`, 'PUT', data);
            } else {
                await apiCall('/admin/available-dates', 'POST', data);
            }
            closeModal('dateModal');
            loadAvailableDates();
            showToast('Date saved successfully');
        });
        
        async function deleteDate(id) {
            if (!confirm('Are you sure you want to delete this date?')) return;
            await apiCall(`/admin/available-dates/${id}`, 'DELETE', {});
            loadAvailableDates();
            showToast('Date deleted');
        }
        
        // Bookings Management
        async function loadBookings() {
            const status = document.getElementById('bookingStatusFilter').value;
            const url = status ? `/admin/bookings?status=${status}` : '/admin/bookings';
            const data = await apiCall(url);
            const tbody = document.querySelector('#bookingsTable tbody');
            tbody.innerHTML = (data.bookings || []).map(b => `
                <tr>
                    <td>${b.booking_id}</td>
                    <td>${b.passenger_name}</td>
                    <td>${b.passenger_phone}</td>
                    <td>${b.from_location} ‚Üí ${b.to_location}</td>
                    <td>${b.travel_date}</td>
                    <td>${(b.selected_seats || []).join(', ')}</td>
                    <td>Rs. ${b.total_amount.toLocaleString()}</td>
                    <td>
                        <select onchange="updateBookingPayment('${b.booking_id}', this.value)" style="padding:4px;">
                            <option value="pending" ${b.payment_status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="confirmed" ${b.payment_status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option value="rejected" ${b.payment_status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateBookingStatus('${b.booking_id}', this.value)" style="padding:4px;">
                            <option value="pending" ${b.booking_status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="confirmed" ${b.booking_status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option value="cancelled" ${b.booking_status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteBooking('${b.booking_id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function updateBookingPayment(bookingId, status) {
            await apiCall(`/admin/bookings/${bookingId}`, 'PUT', { payment_status: status });
            showToast('Payment status updated');
        }
        
        async function updateBookingStatus(bookingId, status) {
            await apiCall(`/admin/bookings/${bookingId}`, 'PUT', { booking_status: status });
            showToast('Booking status updated');
        }
        
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking? Seats will be restored.')) return;
            await apiCall(`/admin/bookings/${bookingId}`, 'DELETE', {});
            loadBookings();
            showToast('Booking deleted');
        }
        
        // Knowledge Base CRUD
        let kbData = [];
        async function loadKB() {
            const data = await apiCall('/admin/knowledge-base');
            kbData = data.entries || [];
            const tbody = document.querySelector('#kbTable tbody');
            tbody.innerHTML = kbData.map(k => `
                <tr>
                    <td>${k.category}</td>
                    <td>${k.question.substring(0, 50)}...</td>
                    <td>${k.answer.substring(0, 60)}...</td>
                    <td>${(k.keywords || []).slice(0, 3).join(', ')}</td>
                    <td><span class="badge badge-${k.is_active ? 'success' : 'secondary'}">${k.is_active ? 'Yes' : 'No'}</span></td>
                    <td class="action-btns">
                        <button class="btn btn-info btn-sm" onclick="editKB('${k.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteKB('${k.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openKBModal(entry = null) {
            document.getElementById('kbModalTitle').textContent = entry ? 'Edit KB Entry' : 'Add KB Entry';
            document.getElementById('kb-id').value = entry?.id || '';
            document.getElementById('kb-category').value = entry?.category || 'general';
            document.getElementById('kb-question').value = entry?.question || '';
            document.getElementById('kb-answer').value = entry?.answer || '';
            document.getElementById('kb-keywords').value = (entry?.keywords || []).join(', ');
            document.getElementById('kbModal').classList.add('active');
        }
        
        function editKB(id) {
            const entry = kbData.find(k => k.id === id);
            openKBModal(entry);
        }
        
        document.getElementById('kbForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('kb-id').value;
            const data = {
                category: document.getElementById('kb-category').value,
                question: document.getElementById('kb-question').value,
                answer: document.getElementById('kb-answer').value,
                keywords: document.getElementById('kb-keywords').value.split(',').map(s => s.trim()).filter(Boolean)
            };
            
            if (id) {
                await apiCall(`/admin/knowledge-base/${id}`, 'PUT', data);
            } else {
                await apiCall('/admin/knowledge-base', 'POST', data);
            }
            closeModal('kbModal');
            loadKB();
            showToast('KB entry saved');
        });
        
        async function deleteKB(id) {
            if (!confirm('Are you sure you want to delete this KB entry?')) return;
            await apiCall(`/admin/knowledge-base/${id}`, 'DELETE', {});
            loadKB();
            showToast('KB entry deleted');
        }
        
        async function rebuildKB() {
            await apiCall('/admin/rebuild-kb', 'POST', {});
            showToast('Knowledge base rebuilt successfully');
        }
        
        // Audit Log
        async function loadAuditLog() {
            const data = await apiCall('/admin/audit-log');
            const tbody = document.querySelector('#auditTable tbody');
            tbody.innerHTML = (data.entries || []).map(e => `
                <tr>
                    <td>${e.created_at?.substring(0, 16).replace('T', ' ') || 'N/A'}</td>
                    <td>...${e.admin_phone?.slice(-4) || 'N/A'}</td>
                    <td>${e.action}</td>
                    <td><small>${JSON.stringify(e.details || {}).substring(0, 50)}</small></td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>